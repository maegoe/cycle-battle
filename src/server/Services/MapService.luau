--!strict
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local MapService = {}
local islandPositions = {} -- GenerateMapê³¼ SpawnItemì—ì„œ ê³µìœ í•˜ê¸° ìœ„í•´ ìœ„ë¡œ ì´ë™
local isGameRunning = false
local gameStartTime = 0
local restartVotes = {}

function MapService.Init()
	print("[MapService] Generating Map...")
	MapService.GenerateMap()
	
	-- ì•„ì´í…œ ì‚¬ìš©ì„ ìœ„í•œ RemoteEvent ìƒì„±
	if not ReplicatedStorage:FindFirstChild("UseItem") then
		local re = Instance.new("RemoteEvent")
		re.Name = "UseItem"
		re.Parent = ReplicatedStorage
	end
	
	-- ì¬ì‹œì‘ íˆ¬í‘œë¥¼ ìœ„í•œ RemoteEvent ìƒì„±
	if not ReplicatedStorage:FindFirstChild("VoteRestart") then
		local ve = Instance.new("RemoteEvent")
		ve.Name = "VoteRestart"
		ve.Parent = ReplicatedStorage
	end

	-- ë§µ(Y=10)ì—ì„œ 60ìŠ¤í„°ë“œ ì•„ë˜(-50)ë¡œ ë–¨ì–´ì§€ë©´ ë¦¬ìŠ¤í°(ì‚¬ë§) ì²˜ë¦¬
	workspace.FallenPartsDestroyHeight = -30
	Players.RespawnTime = 0 -- ë¦¬ìŠ¤í° ë”œë ˆì´ ì œê±°

	-- ë°°ê²½ ìŒì•…(BGM) ì¶”ê°€
	local bgm = Instance.new("Sound")
	bgm.Name = "BackgroundMusic"
	bgm.SoundId = "rbxassetid://1843404009" -- Upbeat Music
	bgm.Looped = true
	bgm.Volume = 0.5
	bgm.Parent = workspace
	bgm:Play()
end

function MapService.Start()
	MapService.RestartGame()
	
	-- 5ë¶„ íƒ€ì´ë¨¸ ì²´í¬ ë£¨í”„
	task.spawn(function()
		while true do
			task.wait(1)
			if isGameRunning then
				local elapsed = os.time() - gameStartTime
				local remaining = 300 - elapsed
				if remaining < 0 then remaining = 0 end
				
				local timeText = string.format("%02d:%02d", math.floor(remaining/60), remaining%60)
				for _, p in ipairs(Players:GetPlayers()) do
					local gui = p:FindFirstChild("PlayerGui")
					local hud = gui and gui:FindFirstChild("GameHUD")
					local tl = hud and hud:FindFirstChild("TimeLabel")
					if tl then tl.Text = timeText end
				end
				
				if elapsed >= 300 then -- 300ì´ˆ = 5ë¶„
					MapService.EndGameByTime()
				end
			end
		end
	end)

	-- ì ìˆ˜ 1ë“±ì—ê²Œ ì´í™íŠ¸ ë¶€ì—¬í•˜ëŠ” í•¨ìˆ˜
	local function UpdateTopPlayerEffect()
		local topPlayer = nil
		local maxScore = -1

		-- í˜„ì¬ ìµœê³  ì ìˆ˜ì™€ í”Œë ˆì´ì–´ ì°¾ê¸°
		for _, p in ipairs(Players:GetPlayers()) do
			local ls = p:FindFirstChild("leaderstats")
			local s = ls and ls:FindFirstChild("Score (1000 Win)")
			if s and s.Value > maxScore then
				maxScore = s.Value
				topPlayer = p
			end
		end

		-- ì´í™íŠ¸ ì ìš© ë° ì œê±°
		for _, p in ipairs(Players:GetPlayers()) do
			local char = p.Character
			local root = char and char:FindFirstChild("HumanoidRootPart")
			if root then
				local effect = root:FindFirstChild("TopPlayerEffect")
				if p == topPlayer and maxScore > 0 then
					if not effect then
						local particles = Instance.new("ParticleEmitter")
						particles.Name = "TopPlayerEffect"
						particles.Texture = "rbxassetid://241556831" -- ë³„ ëª¨ì–‘ í…ìŠ¤ì²˜
						particles.Color = ColorSequence.new(Color3.fromRGB(255, 215, 0)) -- ê¸ˆìƒ‰
						particles.Size = NumberSequence.new(0.5)
						particles.Parent = root
					end
				elseif effect then
					effect:Destroy()
				end
			end
		end
	end

	Players.PlayerRemoving:Connect(UpdateTopPlayerEffect)

	-- 1 & 2. ë©€í‹°í”Œë ˆì´ì–´ ì ìˆ˜íŒ(leaderstats) ì´ˆê¸°í™”
	local function onPlayerAdded(player)
		local leaderstats = Instance.new("Folder")
		leaderstats.Name = "leaderstats"
		leaderstats.Parent = player

		local score = Instance.new("IntValue")
		score.Name = "Score (1000 Win)"
		score.Value = 0
		score.Parent = leaderstats

		score.Changed:Connect(UpdateTopPlayerEffect)
		player.CharacterAdded:Connect(UpdateTopPlayerEffect)

		-- ì¸ë²¤í† ë¦¬ í´ë” ìƒì„± (UI í‘œì‹œìš©)
		local inventory = Instance.new("Folder")
		inventory.Name = "Inventory"
		inventory.Parent = player

		-- ëª©í‘œ í‘œì‹œ UI ìƒì„±
		task.spawn(function()
			local playerGui = player:WaitForChild("PlayerGui", 10)
			if playerGui then
				local screenGui = Instance.new("ScreenGui")
				screenGui.Name = "GameHUD"
				screenGui.ResetOnSpawn = false
				screenGui.Parent = playerGui
				
				local label = Instance.new("TextLabel")
				label.Name = "TargetLabel"
				label.Size = UDim2.new(0, 400, 0, 50)
				label.Position = UDim2.new(0.5, -200, 0, 10)
				label.BackgroundTransparency = 1
				label.Font = Enum.Font.GothamBlack
				label.TextSize = 32
				label.TextStrokeTransparency = 0
				label.Parent = screenGui
				
				-- ë‚¨ì€ ì‹œê°„ í‘œì‹œ UI
				local timeLabel = Instance.new("TextLabel")
				timeLabel.Name = "TimeLabel"
				timeLabel.Size = UDim2.new(0, 100, 0, 40)
				timeLabel.Position = UDim2.new(0.5, -50, 0, 60)
				timeLabel.BackgroundTransparency = 1
				timeLabel.Font = Enum.Font.GothamBold
				timeLabel.TextSize = 28
				timeLabel.TextColor3 = Color3.new(1, 1, 1)
				timeLabel.TextStrokeTransparency = 0
				timeLabel.Text = "05:00"
				timeLabel.Parent = screenGui
				
				-- ìŠ¹ë¦¬ ë©”ì‹œì§€ UI
				local winLabel = Instance.new("TextLabel")
				winLabel.Name = "WinLabel"
				winLabel.Size = UDim2.new(1, 0, 0, 100)
				winLabel.Position = UDim2.new(0, 0, 0.4, 0)
				winLabel.BackgroundTransparency = 1
				winLabel.Font = Enum.Font.GothamBlack
				winLabel.TextScaled = true
				winLabel.TextColor3 = Color3.new(1, 0.8, 0)
				winLabel.TextStrokeTransparency = 0
				winLabel.Visible = false
				winLabel.Parent = screenGui

				-- ì¬ì‹œì‘ íˆ¬í‘œ ë²„íŠ¼
				local voteBtn = Instance.new("TextButton")
				voteBtn.Name = "VoteButton"
				voteBtn.Size = UDim2.new(0, 120, 0, 40)
				voteBtn.Position = UDim2.new(1, -130, 1, -50) -- ìš°ì¸¡ í•˜ë‹¨ìœ¼ë¡œ ì´ë™
				voteBtn.Text = "Vote Restart"
				voteBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
				voteBtn.TextColor3 = Color3.new(1, 1, 1)
				voteBtn.Parent = screenGui
				
				local function updateText()
					local target = player:GetAttribute("NextTargetIsland")
					if target == 1 then
						label.Text = "Next Map: Red Island"
						label.TextColor3 = Color3.fromRGB(255, 80, 80)
					elseif target == 2 then
						label.Text = "Next Map: Blue Island"
						label.TextColor3 = Color3.fromRGB(80, 80, 255)
					elseif target == 3 then
						label.Text = "Next Map: Yellow Island"
						label.TextColor3 = Color3.fromRGB(255, 255, 80)
					else
						label.Text = "ì¤€ë¹„ ì¤‘..."
						label.TextColor3 = Color3.new(1, 1, 1)
					end
				end
				
				player:GetAttributeChangedSignal("NextTargetIsland"):Connect(updateText)
				updateText()
			end
		end)

		-- ë–¨ì–´ì§ˆ ë•Œ ë¹„ëª… ì†Œë¦¬ ì¶”ê°€
		player.CharacterAdded:Connect(function(char)
			-- ì˜µì €ë²„ì¸ ê²½ìš° ìºë¦­í„° ì„¤ì • (íˆ¬ëª…, ì¶©ëŒ ì—†ìŒ)
			if player:GetAttribute("IsObserver") then
				MapService.SetupObserverCharacter(player, char)
				return
			end

			local humanoid = char:WaitForChild("Humanoid")
			if humanoid then
				humanoid.WalkSpeed = 48 -- ê¸°ë³¸ ì´ë™ì†ë„ 3ë°°
			end
			
			-- ë¦¬ìŠ¤í° ì‹œ ì„¬ ë°©ë¬¸ ìˆœì„œ ì´ˆê¸°í™” (ì ìƒ‰ ì„¬ì—ì„œ ì‹œì‘í•˜ë¯€ë¡œ Next MapëŠ” ë…¸ë€ìƒ‰)
			player:SetAttribute("NextTargetIsland", 3)

			local root = char:WaitForChild("HumanoidRootPart", 10)
			if not root then return end
			
			local connection
			connection = RunService.Heartbeat:Connect(function()
				if not char.Parent or not root.Parent then connection:Disconnect() return end
				
				if root.Position.Y < -5 and not root:FindFirstChild("ScreamSound") then
					local sound = Instance.new("Sound")
					sound.Name = "ScreamSound"
					sound.SoundId = "rbxassetid://9113601347" -- ë¹„ëª… ì†Œë¦¬
					sound.Volume = 1.5
					sound.Parent = root
					sound:Play()
				end
			end)
		end)
	end

	Players.PlayerAdded:Connect(onPlayerAdded)
	
	-- ì´ë¯¸ ì ‘ì†í•œ í”Œë ˆì´ì–´ ì²˜ë¦¬
	for _, player in ipairs(Players:GetPlayers()) do
		onPlayerAdded(player)
	end
	
	-- ê²Œì„ ë„ì¤‘ ì ‘ì†ì ì²˜ë¦¬ (ì˜µì €ë²„)
	Players.PlayerAdded:Connect(function(player)
		-- ê²Œì„ ì‹œì‘ í›„ 10ì´ˆê°€ ì§€ë‚¬ë‹¤ë©´ ì˜µì €ë²„ë¡œ ì„¤ì •
		if isGameRunning and (os.time() - gameStartTime > 10) then
			player:SetAttribute("IsObserver", true)
			print(player.Name .. " ë‹˜ì´ ê²Œì„ ë„ì¤‘ ì ‘ì†í•˜ì—¬ ì˜µì €ë²„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.")
		end
	end)
	
	-- ì•„ì´í…œ ì‚¬ìš© ìš”ì²­ ì²˜ë¦¬
	ReplicatedStorage:WaitForChild("UseItem").OnServerEvent:Connect(function(player)
		MapService.UseItem(player)
	end)
	
	-- ì¬ì‹œì‘ íˆ¬í‘œ ìš”ì²­ ì²˜ë¦¬
	ReplicatedStorage:WaitForChild("VoteRestart").OnServerEvent:Connect(function(player)
		if not table.find(restartVotes, player) then
			table.insert(restartVotes, player)
			local required = MapService.GetRestartThreshold()
			print(string.format("ì¬ì‹œì‘ íˆ¬í‘œ: %d/%d", #restartVotes, required))
			
			-- íˆ¬í‘œ í˜„í™© ì•Œë¦¼ (ì±„íŒ…)
			local msg = string.format("[System] ì¬ì‹œì‘ íˆ¬í‘œ: %d/%d", #restartVotes, required)
			-- ê°„ë‹¨íˆ ì„œë²„ ë¡œê·¸ë¡œ ëŒ€ì²´í•˜ê±°ë‚˜ ChatServiceë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŒ
			
			if #restartVotes >= required then
				MapService.RestartGame()
			end
		end
	end)

	-- ì•„ì´í…œ ìƒì„± ë£¨í”„ (10~20ì´ˆ ê°„ê²©)
	task.spawn(function()
		while true do
			task.wait(math.random(5, 10))
			MapService.SpawnRandomItem()
		end
	end)
end

function MapService.GetRestartThreshold()
	local playerCount = #Players:GetPlayers()
	if playerCount <= 2 then return 1 end -- 1ëª…: ì¦‰ì‹œ, 2ëª…: 1ëª… ë™ì˜
	if playerCount <= 4 then return 2 end -- 3~4ëª…: 2ëª… ë™ì˜
	if playerCount <= 7 then return 3 end -- 5~7ëª…: 3ëª… ë™ì˜
	return 4 -- 8ëª… ì´ìƒ: 4ëª… ë™ì˜
end

function MapService.AnnounceWinner(text)
	isGameRunning = false
	print(text)
	for _, p in ipairs(Players:GetPlayers()) do
		local gui = p:FindFirstChild("PlayerGui")
		local hud = gui and gui:FindFirstChild("GameHUD")
		local winLabel = hud and hud:FindFirstChild("WinLabel")
		if winLabel then
			winLabel.Text = text
			winLabel.Visible = true
		end
	end
	
	task.delay(5, function()
		MapService.RestartGame()
	end)
end

function MapService.RestartGame()
	print("ğŸ”„ ê²Œì„ì„ ì¬ì‹œì‘í•©ë‹ˆë‹¤!")
	isGameRunning = false
	restartVotes = {}
	
	-- ë§µ ì´ˆê¸°í™” (ê¸°ì¡´ ì„¬, ë‹¤ë¦¬, ì•„ì´í…œ ì œê±°)
	for _, child in ipairs(workspace:GetChildren()) do
		if child.Name:match("Island_") or child.Name:match("Bridge") or child.Name == "ItemBox" or child.Name == "Wall" then
			child:Destroy()
		end
	end
	
	MapService.GenerateMap()
	
	-- í”Œë ˆì´ì–´ ì´ˆê¸°í™”
	for _, p in ipairs(Players:GetPlayers()) do
		local ls = p:FindFirstChild("leaderstats")
		local s = ls and ls:FindFirstChild("Score (1000 Win)")
		if s then s.Value = 0 end
		
		p:SetAttribute("NextTargetIsland", 0) -- 0ìœ¼ë¡œ ì´ˆê¸°í™” (ì¤€ë¹„ ì¤‘)
		p:SetAttribute("IsObserver", nil) -- ì˜µì €ë²„ í•´ì œ
		p:LoadCharacter() -- ë¦¬ìŠ¤í°
		
		-- UI ì´ˆê¸°í™”
		local gui = p:FindFirstChild("PlayerGui")
		local hud = gui and gui:FindFirstChild("GameHUD")
		if hud then
			local winLabel = hud:FindFirstChild("WinLabel")
			if winLabel then winLabel.Visible = false end
		end
	end
	
	task.spawn(function()
		local redIslandPos = islandPositions[1]
		
		-- 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´
		for i = 5, 1, -1 do
			for _, p in ipairs(Players:GetPlayers()) do
				local gui = p:FindFirstChild("PlayerGui")
				local hud = gui and gui:FindFirstChild("GameHUD")
				local targetLabel = hud and hud:FindFirstChild("TargetLabel")
				if targetLabel then
					targetLabel.Text = "Game Starts in " .. i
					targetLabel.TextColor3 = Color3.new(1, 1, 1)
				end
			end
			
			-- ìœ„ì¹˜ ë³´ì • (ë¹¨ê°„ ì„¬ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ë³µê·€)
			local endTime = os.clock() + 1
			while os.clock() < endTime do
				for _, p in ipairs(Players:GetPlayers()) do
					if p:GetAttribute("IsObserver") then continue end
					local char = p.Character
					local root = char and char:FindFirstChild("HumanoidRootPart")
					if root and redIslandPos then
						local dist = (Vector3.new(root.Position.X, 0, root.Position.Z) - Vector3.new(redIslandPos.X, 0, redIslandPos.Z)).Magnitude
						if dist > 40 then
							root.CFrame = CFrame.new(redIslandPos + Vector3.new(0, 5, 0))
						end
					end
				end
				task.wait(0.1)
			end
		end
		
		gameStartTime = os.time()
		isGameRunning = true
		
		-- UI ê°±ì‹  (Next Map í‘œì‹œ)
		for _, p in ipairs(Players:GetPlayers()) do
			p:SetAttribute("NextTargetIsland", 3) -- 3ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì‹œì‘ (ë…¸ë€ìƒ‰ ëª©í‘œ)

			local gui = p:FindFirstChild("PlayerGui")
			local hud = gui and gui:FindFirstChild("GameHUD")
			local targetLabel = hud and hud:FindFirstChild("TargetLabel")
			if targetLabel then
				targetLabel.Text = "Next Map: Yellow Island"
				targetLabel.TextColor3 = Color3.fromRGB(255, 255, 80)
			end
		end
	end)
end

function MapService.EndGameByTime()
	local maxScore = -1
	local winners = {}
	
	for _, p in ipairs(Players:GetPlayers()) do
		local ls = p:FindFirstChild("leaderstats")
		local s = ls and ls:FindFirstChild("Score (1000 Win)")
		local score = s and s.Value or 0
		
		if score > maxScore then
			maxScore = score
			winners = {p}
		elseif score == maxScore then
			table.insert(winners, p)
		end
	end
	
	if maxScore <= 0 then
		MapService.AnnounceWinner("No winner : (")
	elseif #winners == 1 then
		MapService.AnnounceWinner(winners[1].Name .. " Win!")
	else
		local names = {}
		for _, w in ipairs(winners) do
			table.insert(names, w.Name)
		end
		MapService.AnnounceWinner(table.concat(names, ", ") .. " Co-Win!")
	end
end

function MapService.SetupObserverCharacter(player, char)
	task.wait(0.1) -- ìºë¦­í„° ë¡œë“œ ëŒ€ê¸°
	for _, part in ipairs(char:GetDescendants()) do
		if part:IsA("BasePart") then
			part.Transparency = 0.5
			part.CanCollide = false
			part.CastShadow = false
		end
	end
	
	local root = char:WaitForChild("HumanoidRootPart")
	if root then
		root.Anchored = false
	end
	
	-- ì˜µì €ë²„ëŠ” ì´ë¦„í‘œ ìˆ¨ê¸°ê¸° ë“± ì¶”ê°€ ì²˜ë¦¬ ê°€ëŠ¥
	print(player.Name .. " (ì˜µì €ë²„) ìŠ¤í° ì™„ë£Œ")
end

function MapService.GenerateMap()
	islandPositions = {}
	-- ê¸°ì¡´(ê¸°ë³¸) ìŠ¤í° í¬ì¸íŠ¸ ì œê±°
	for _, child in ipairs(workspace:GetChildren()) do
		if child:IsA("SpawnLocation") then
			child:Destroy()
		end
	end

	local center = Vector3.new(0, 10, 0)
	local radiusFromCenter = 120
	local islandRadius = 40
	local islandHeight = 5
	local bridgeWidth = 30
	
	local islandColors = {
		Color3.fromRGB(255, 0, 0),   -- ì ìƒ‰
		Color3.fromRGB(0, 0, 255),   -- íŒŒë€ìƒ‰
		Color3.fromRGB(255, 255, 0)  -- ë…¸ë€ìƒ‰
	}
	
	-- 1. ì„¬ 3ê°œ ìƒì„± (ì •ì‚¼ê°í˜• ë°°ì¹˜)
	for i = 1, 3 do
		local angle = math.rad((i - 1) * 120)
		local offsetX = math.cos(angle) * radiusFromCenter
		local offsetZ = math.sin(angle) * radiusFromCenter
		local position = center + Vector3.new(offsetX, 0, offsetZ)
		
		table.insert(islandPositions, position)
		
		local island = Instance.new("Part")
		island.Name = "Island_" .. i
		island.Shape = Enum.PartType.Cylinder
		island.Anchored = true
		island.Material = Enum.Material.Grass
		island.Color = islandColors[i]
		-- CylinderëŠ” Xì¶•ì´ ë†’ì´(ë‘ê»˜)ì…ë‹ˆë‹¤.
		island.Size = Vector3.new(islandHeight, islandRadius * 2, islandRadius * 2)
		-- ëˆ•í˜€ì„œ í‰í‰í•˜ê²Œ ë§Œë“¤ê¸° ìœ„í•´ Zì¶•ìœ¼ë¡œ 90ë„ íšŒì „
		island.CFrame = CFrame.new(position) * CFrame.Angles(0, 0, math.rad(90))
		island.Parent = workspace

		-- ì„¬ ë°©ë¬¸ ë¡œì§ (ì ìƒ‰ -> ë…¸ë€ìƒ‰ -> íŒŒë€ìƒ‰ ìˆœì„œ)
		island.Touched:Connect(function(hit)
			local player = Players:GetPlayerFromCharacter(hit.Parent)
			if not player or not player.Character or player.Character.Humanoid.Health <= 0 or player:GetAttribute("IsObserver") then return end
			
			local nextTarget = player:GetAttribute("NextTargetIsland") or 3
			
			if i == nextTarget then
				if i == 3 then -- ë…¸ë€ìƒ‰(3) -> ë‹¤ìŒ íŒŒë€ìƒ‰(2)
					player:SetAttribute("NextTargetIsland", 2)
					print(player.Name .. ": ë…¸ë€ìƒ‰ ì„¬ í†µê³¼! ë‹¤ìŒì€ íŒŒë€ìƒ‰ ì„¬ì…ë‹ˆë‹¤.")
				elseif i == 2 then -- íŒŒë€ìƒ‰(2) -> ë‹¤ìŒ ì ìƒ‰(1)
					player:SetAttribute("NextTargetIsland", 1)
					print(player.Name .. ": íŒŒë€ìƒ‰ ì„¬ í†µê³¼! ë‹¤ìŒì€ ì ìƒ‰ ì„¬ì…ë‹ˆë‹¤.")
				elseif i == 1 then -- ì ìƒ‰(1) -> ì™„ì£¼ -> ë‹¤ì‹œ ë…¸ë€ìƒ‰(3)
					player:SetAttribute("NextTargetIsland", 3)
					local leaderstats = player:FindFirstChild("leaderstats")
					local score = leaderstats and leaderstats:FindFirstChild("Score (1000 Win)")
					if score then 
						score.Value += 100
						
						-- ìŠ¹ë¦¬ ì¡°ê±´ ì²´í¬ (1000ì  ë‹¬ì„±)
						if score.Value >= 1000 then
							print("ğŸ† " .. player.Name .. " ë‹˜ì´ 1000ì ì„ ë‹¬ì„±í•˜ì—¬ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! (ê²Œì„ ì´ˆê¸°í™”)")
							MapService.AnnounceWinner(player.Name .. " Win!")
						end
					end
					print(player.Name .. ": ì½”ìŠ¤ ì™„ì£¼! 100ì  íšë“.")
				end
			end
		end)

		-- ìŠ¤í° í¬ì¸íŠ¸ ì¶”ê°€
		if i == 1 then -- ì ìƒ‰ ì„¬(ì²« ë²ˆì§¸)ì—ë§Œ ìŠ¤í° ìƒì„±
			local spawn = Instance.new("SpawnLocation")
			spawn.Name = "SpawnLocation_" .. i
			spawn.Anchored = true
			spawn.Size = Vector3.new(16, 1, 16)
			spawn.Position = position + Vector3.new(0, islandHeight / 2 + 5, 0) -- ìŠ¤í° ìœ„ì¹˜ ìœ„ë¡œ ì´ë™
			spawn.Neutral = true
			spawn.Transparency = 1
			spawn.CanCollide = false
			spawn.Parent = workspace
		end
	end
	
	-- 2. ë‹¤ë¦¬ ì—°ê²° (1-2, 2-3, 3-1) - ê³¡ì„  ë‹¤ë¦¬ ì ìš©
	local bridgeSegments = 20 -- ê³¡ì„ ì„ êµ¬ì„±í•  íŒŒíŠ¸ ê°œìˆ˜ (ì¡°ì • ê°€ëŠ¥: ë†’ì„ìˆ˜ë¡ ë¶€ë“œëŸ¬ì›€)
	local curvature = 60 -- ê³¡ë¥  (ì¡°ì • ê°€ëŠ¥: í´ìˆ˜ë¡ ë°”ê¹¥ìª½ìœ¼ë¡œ ë§ì´ íœ¨)

	local function getBezierPoint(t, p0, p1, p2)
		return (1 - t)^2 * p0 + 2 * (1 - t) * t * p1 + t^2 * p2
	end

	for i = 1, 3 do
		local p0 = islandPositions[i]
		local p2 = islandPositions[(i % 3) + 1]
		
		-- ì œì–´ì (Control Point) ê³„ì‚°: ë‘ ì„¬ì˜ ì¤‘ê°„ ì§€ì ì—ì„œ ì¤‘ì‹¬ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ curvatureë§Œí¼ ì´ë™
		local midPoint = (p0 + p2) / 2
		local dir = (midPoint - center).Unit
		local p1 = midPoint + (dir * curvature)
		
		for j = 1, bridgeSegments do
			local t1 = (j - 1) / bridgeSegments
			local t2 = j / bridgeSegments
			
			local startPos = getBezierPoint(t1, p0, p1, p2)
			local endPos = getBezierPoint(t2, p0, p1, p2)
			local segDist = (endPos - startPos).Magnitude
			local segCenter = (startPos + endPos) / 2
			
			local bridge = Instance.new("Part")
			bridge.Name = "BridgeSegment"
			bridge.Anchored = true
			bridge.Material = Enum.Material.Wood
			bridge.Color = Color3.fromRGB(139, 69, 19) -- ê°ˆìƒ‰
			bridge.Size = Vector3.new(bridgeWidth, 1, segDist + 0.5) -- í‹ˆìƒˆ ë°©ì§€ ì˜¤ë²„ë©
			bridge.CFrame = CFrame.lookAt(segCenter, endPos)
			bridge.Parent = workspace
			
			-- ë‹¤ë¦¬ ë‚œê°„ ìƒì„±
			if (segCenter - p0).Magnitude > islandRadius and (segCenter - p2).Magnitude > islandRadius then
				local wallHeight = 10
				local wallThickness = 1
				for _, side in ipairs({-1, 1}) do
					local wall = Instance.new("Part")
					wall.Name = "BridgeWall"
					wall.Anchored = true
					wall.Material = Enum.Material.Wood
					wall.Color = Color3.fromRGB(139, 69, 19)
					wall.Size = Vector3.new(wallThickness, wallHeight, segDist + 0.5)
					wall.CFrame = bridge.CFrame * CFrame.new(side * (bridgeWidth/2 - wallThickness/2), 0.5 + wallHeight/2, 0)
					wall.Parent = workspace
				end
			end
		end
	end

	-- 3. ì„¬ ì£¼ìœ„ì— ë²½ ìƒì„± (ë‹¤ë¦¬ ì—°ê²° ë¶€ìœ„ ì œì™¸)
	local wallHeight = 10
	for i = 1, 3 do
		local currentPos = islandPositions[i]
		local nextIndex = (i % 3) + 1
		local prevIndex = (i - 2) % 3 + 1
		
		local nextPos = islandPositions[nextIndex]
		local prevPos = islandPositions[prevIndex]
		
		-- Outgoing Bridge Control Point (to Next)
		local midOut = (currentPos + nextPos) / 2
		local dirOut = (midOut - center).Unit
		local p1Out = midOut + (dirOut * curvature)
		local vecOut = (p1Out - currentPos) * Vector3.new(1,0,1)
		
		-- Incoming Bridge Control Point (from Prev)
		local midIn = (prevPos + currentPos) / 2
		local dirIn = (midIn - center).Unit
		local p1In = midIn + (dirIn * curvature)
		local vecIn = (p1In - currentPos) * Vector3.new(1,0,1)
		
		local angleOut = math.atan2(vecOut.Z, vecOut.X)
		local angleIn = math.atan2(vecIn.Z, vecIn.X)
		
		local numSegments = 80
		local angleStep = (2 * math.pi) / numSegments
		local gapHalfAngle = math.atan((bridgeWidth / 2 + 2) / islandRadius) -- ë‹¤ë¦¬ ë„ˆë¹„ì— ë§ì¶° ê°ë„ ê³„ì‚°
		
		local function getAngleDiff(a, b)
			local diff = math.abs(a - b)
			while diff > math.pi do diff = diff - 2 * math.pi end
			return math.abs(diff)
		end
		
		for j = 1, numSegments do
			local angle = (j - 1) * angleStep
			
			if getAngleDiff(angle, angleOut) > gapHalfAngle and getAngleDiff(angle, angleIn) > gapHalfAngle then
				local x = math.cos(angle) * islandRadius
				local z = math.sin(angle) * islandRadius
				-- ì„¬ í‘œë©´(Y=12.5) ìœ„ì— ë²½(ë†’ì´ 5)ì„ ì˜¬ë¦¬ë¯€ë¡œ ì¤‘ì‹¬ YëŠ” 12.5 + 2.5 = 15
				local wallPos = currentPos + Vector3.new(x, islandHeight/2 + wallHeight/2, z)
				
				local wall = Instance.new("Part")
				wall.Name = "Island_Wall"
				wall.Anchored = true
				wall.Material = Enum.Material.Wood
				wall.Color = Color3.fromRGB(139, 69, 19)
				wall.Size = Vector3.new(1, wallHeight, (2 * math.pi * islandRadius / numSegments) + 0.5)
				wall.CFrame = CFrame.lookAt(wallPos, currentPos) * CFrame.Angles(0, math.rad(90), 0)
				wall.Parent = workspace
			end
		end
	end
end

-- ì•„ì´í…œ ì¢…ë¥˜ ì •ì˜
local ITEM_TYPES = {"SpeedBoost", "StunGun", "Wall"}

function MapService.SpawnRandomItem()
	if #islandPositions == 0 then return end
	
	-- ì•„ì´í…œì´ ì—†ëŠ” ì„¬ ì°¾ê¸°
	local availableIslands = {}
	for _, pos in ipairs(islandPositions) do
		local isOccupied = false
		local checkPos = pos + Vector3.new(0, 3, 0)
		local parts = workspace:GetPartBoundsInRadius(checkPos, 5)
		for _, part in ipairs(parts) do
			if part.Name == "ItemBox" then
				isOccupied = true
				break
			end
		end
		if not isOccupied then
			table.insert(availableIslands, pos)
		end
	end

	if #availableIslands == 0 then return end

	local randomIslandPos = availableIslands[math.random(1, #availableIslands)]
	local itemType = ITEM_TYPES[math.random(1, #ITEM_TYPES)]
	
	local itemPart = Instance.new("Part")
	itemPart.Name = "ItemBox"
	itemPart.Size = Vector3.new(2, 2, 2)
	itemPart.Position = randomIslandPos + Vector3.new(0, 3, 0)
	itemPart.Color = Color3.fromRGB(255, 0, 255) -- ë³´ë¼ìƒ‰ ë°•ìŠ¤
	itemPart.Material = Enum.Material.Neon
	itemPart.Anchored = false
	itemPart.Parent = workspace
	
	-- ì•„ì´í…œ í…ìŠ¤íŠ¸ í‘œì‹œ
	local billboard = Instance.new("BillboardGui")
	billboard.Size = UDim2.new(0, 100, 0, 50)
	billboard.Adornee = itemPart
	billboard.AlwaysOnTop = true
	billboard.Parent = itemPart
	
	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(1, 0, 1, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.Text = itemType
	textLabel.TextColor3 = Color3.new(1, 1, 1)
	textLabel.TextStrokeTransparency = 0
	textLabel.Parent = billboard

	-- íšë“ ë¡œì§
	local collected = false
	itemPart.Touched:Connect(function(hit)
		if collected then return end
		local player = Players:GetPlayerFromCharacter(hit.Parent)
		if player and not player:GetAttribute("IsObserver") then
			-- ì¸ë²¤í† ë¦¬ í™•ì¸ (Folder ì‚¬ìš©)
			local inventory = player:FindFirstChild("Inventory")
			if not inventory then
				inventory = Instance.new("Folder")
				inventory.Name = "Inventory"
				inventory.Parent = player
			end
			
			if #inventory:GetChildren() < 2 then
				collected = true
				local itemValue = Instance.new("StringValue")
				itemValue.Name = "Item"
				itemValue.Value = itemType
				itemValue.Parent = inventory
				
				itemPart:Destroy()
				print(player.Name .. " ë‹˜ì´ ì•„ì´í…œ íšë“: " .. itemType)
			end
		end
	end)
	
	Debris:AddItem(itemPart, 30) -- 30ì´ˆ í›„ ì‚­ì œ (ì²­ì†Œ)
end

function MapService.UseItem(player)
	if player:GetAttribute("IsObserver") then return end -- ì˜µì €ë²„ëŠ” ì•„ì´í…œ ì‚¬ìš© ë¶ˆê°€
	local inventory = player:FindFirstChild("Inventory")
	if not inventory then return end
	
	local items = inventory:GetChildren()
	if #items > 0 then
		local itemToUse = items[1] -- ì²« ë²ˆì§¸ ì•„ì´í…œ ì‚¬ìš© (FIFO)
		local itemType = itemToUse.Value
		itemToUse:Destroy() -- ì¸ë²¤í† ë¦¬ì—ì„œ ì œê±°
		
		local char = player.Character
		if not char then return end
		local root = char:FindFirstChild("HumanoidRootPart")
		local humanoid = char:FindFirstChild("Humanoid")
		
		print(player.Name .. " ì•„ì´í…œ ì‚¬ìš©: " .. itemType)
		
		local sound = Instance.new("Sound")
		sound.SoundId = "rbxassetid://12221967" -- ì•„ì´í…œ ì‚¬ìš© íš¨ê³¼ìŒ
		sound.Parent = root
		sound:Play()
		Debris:AddItem(sound, 1)

		if itemType == "SpeedBoost" then
			-- 1. ì´ë™ì†ë„ ì¦ê°€ (3ì´ˆê°„ 3ë°°)
			local originalSpeed = humanoid.WalkSpeed
			humanoid.WalkSpeed = originalSpeed * 3
			task.delay(3, function()
				if humanoid then humanoid.WalkSpeed = originalSpeed end
			end)
			
		elseif itemType == "StunGun" then
			-- 3. ìŠ¤í„´ì´ (íˆ¬ì‚¬ì²´ ë°œì‚¬)
			if root then
				local bullet = Instance.new("Part")
				bullet.Size = Vector3.new(1, 1, 2)
				bullet.Color = Color3.fromRGB(255, 255, 0)
				bullet.Material = Enum.Material.Neon
				bullet.CFrame = root.CFrame * CFrame.new(0, 0, -3)
				bullet.Velocity = root.CFrame.LookVector * 100
				bullet.CanCollide = false
				bullet.Parent = workspace
				
				bullet.Touched:Connect(function(hit)
					if hit.Parent == char then return end -- ìê¸° ìì‹  ë¬´ì‹œ
					local targetHum = hit.Parent:FindFirstChild("Humanoid") -- ì˜µì €ë²„ ì²´í¬ëŠ” ë¬¼ë¦¬ ì¶©ëŒ ì—†ìŒìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ íšŒí”¼ë¨
					if targetHum then
						local targetRoot = hit.Parent:FindFirstChild("HumanoidRootPart")
						if targetRoot then
							targetRoot.Anchored = true
							task.delay(3, function()
								if targetRoot then targetRoot.Anchored = false end
							end)
							bullet:Destroy()
						end
					end
				end)
				Debris:AddItem(bullet, 3) -- 3ì´ˆ í›„(ë§µ ë²—ì–´ë‚˜ë©´) ì‚­ì œ
			end
			
		elseif itemType == "Wall" then
			-- 4. ë²½ ìƒì„±
			if root then
				local wall = Instance.new("Part")
				wall.Size = Vector3.new(30, 30, 2)
				wall.CFrame = root.CFrame * CFrame.new(0, 0, 10)
				wall.Anchored = true
				wall.BrickColor = BrickColor.new("Dark stone grey")
				wall.Parent = workspace
				
				-- 8ì´ˆ í›„ ì„œì„œíˆ íˆ¬ëª…í•´ì§€ë©° ì‚¬ë¼ì§ (ì´ 10ì´ˆ ì§€ì†)
				task.delay(8, function()
					if wall and wall.Parent then
						local tween = TweenService:Create(wall, TweenInfo.new(2), {Transparency = 1})
						tween:Play()
						tween.Completed:Connect(function()
							wall:Destroy()
						end)
					end
				end)
			end
		end
	end
end

return MapService