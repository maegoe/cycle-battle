--!strict
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local MapService = {}
local islandPositions = {} -- GenerateMapê³¼ SpawnItemì—ì„œ ê³µìœ í•˜ê¸° ìœ„í•´ ìœ„ë¡œ ì´ë™

function MapService.Init()
	print("[MapService] Generating Map...")
	MapService.GenerateMap()
	
	-- ì•„ì´í…œ ì‚¬ìš©ì„ ìœ„í•œ RemoteEvent ìƒì„±
	if not ReplicatedStorage:FindFirstChild("UseItem") then
		local re = Instance.new("RemoteEvent")
		re.Name = "UseItem"
		re.Parent = ReplicatedStorage
	end

	-- ë§µ(Y=10)ì—ì„œ 60ìŠ¤í„°ë“œ ì•„ë˜(-50)ë¡œ ë–¨ì–´ì§€ë©´ ë¦¬ìŠ¤í°(ì‚¬ë§) ì²˜ë¦¬
	workspace.FallenPartsDestroyHeight = -30
	Players.RespawnTime = 0 -- ë¦¬ìŠ¤í° ë”œë ˆì´ ì œê±°

	-- ë°°ê²½ ìŒì•…(BGM) ì¶”ê°€
	local bgm = Instance.new("Sound")
	bgm.Name = "BackgroundMusic"
	bgm.SoundId = "rbxassetid://1843404009" -- Upbeat Music
	bgm.Looped = true
	bgm.Volume = 0.5
	bgm.Parent = workspace
	bgm:Play()
end

function MapService.Start()
	-- ì ìˆ˜ 1ë“±ì—ê²Œ ì´í™íŠ¸ ë¶€ì—¬í•˜ëŠ” í•¨ìˆ˜
	local function UpdateTopPlayerEffect()
		local topPlayer = nil
		local maxScore = -1

		-- í˜„ì¬ ìµœê³  ì ìˆ˜ì™€ í”Œë ˆì´ì–´ ì°¾ê¸°
		for _, p in ipairs(Players:GetPlayers()) do
			local ls = p:FindFirstChild("leaderstats")
			local s = ls and ls:FindFirstChild("Score (1000 Win)")
			if s and s.Value > maxScore then
				maxScore = s.Value
				topPlayer = p
			end
		end

		-- ì´í™íŠ¸ ì ìš© ë° ì œê±°
		for _, p in ipairs(Players:GetPlayers()) do
			local char = p.Character
			local root = char and char:FindFirstChild("HumanoidRootPart")
			if root then
				local effect = root:FindFirstChild("TopPlayerEffect")
				if p == topPlayer and maxScore > 0 then
					if not effect then
						local particles = Instance.new("ParticleEmitter")
						particles.Name = "TopPlayerEffect"
						particles.Texture = "rbxassetid://241556831" -- ë³„ ëª¨ì–‘ í…ìŠ¤ì²˜
						particles.Color = ColorSequence.new(Color3.fromRGB(255, 215, 0)) -- ê¸ˆìƒ‰
						particles.Size = NumberSequence.new(0.5)
						particles.Parent = root
					end
				elseif effect then
					effect:Destroy()
				end
			end
		end
	end

	Players.PlayerRemoving:Connect(UpdateTopPlayerEffect)

	-- 1 & 2. ë©€í‹°í”Œë ˆì´ì–´ ì ìˆ˜íŒ(leaderstats) ì´ˆê¸°í™”
	local function onPlayerAdded(player)
		local leaderstats = Instance.new("Folder")
		leaderstats.Name = "leaderstats"
		leaderstats.Parent = player

		local score = Instance.new("IntValue")
		score.Name = "Score (1000 Win)"
		score.Value = 0
		score.Parent = leaderstats

		score.Changed:Connect(UpdateTopPlayerEffect)
		player.CharacterAdded:Connect(UpdateTopPlayerEffect)

		-- ì¸ë²¤í† ë¦¬ í´ë” ìƒì„± (UI í‘œì‹œìš©)
		local inventory = Instance.new("Folder")
		inventory.Name = "Inventory"
		inventory.Parent = player

		-- ëª©í‘œ í‘œì‹œ UI ìƒì„±
		task.spawn(function()
			local playerGui = player:WaitForChild("PlayerGui", 10)
			if playerGui then
				local screenGui = Instance.new("ScreenGui")
				screenGui.Name = "GameHUD"
				screenGui.ResetOnSpawn = false
				screenGui.Parent = playerGui
				
				local label = Instance.new("TextLabel")
				label.Name = "TargetLabel"
				label.Size = UDim2.new(0, 400, 0, 50)
				label.Position = UDim2.new(0.5, -200, 0, 10)
				label.BackgroundTransparency = 1
				label.Font = Enum.Font.GothamBlack
				label.TextSize = 32
				label.TextStrokeTransparency = 0
				label.Parent = screenGui
				
				local function updateText()
					local target = player:GetAttribute("NextTargetIsland")
					if target == 1 then
						label.Text = "Next Map: Red Island"
						label.TextColor3 = Color3.fromRGB(255, 80, 80)
					elseif target == 2 then
						label.Text = "Next Map: Blue Island"
						label.TextColor3 = Color3.fromRGB(80, 80, 255)
					elseif target == 3 then
						label.Text = "Next Map: Yellow Island"
						label.TextColor3 = Color3.fromRGB(255, 255, 80)
					else
						label.Text = "ì¤€ë¹„ ì¤‘..."
						label.TextColor3 = Color3.new(1, 1, 1)
					end
				end
				
				player:GetAttributeChangedSignal("NextTargetIsland"):Connect(updateText)
				updateText()
			end
		end)

		-- ë–¨ì–´ì§ˆ ë•Œ ë¹„ëª… ì†Œë¦¬ ì¶”ê°€
		player.CharacterAdded:Connect(function(char)
			local humanoid = char:WaitForChild("Humanoid")
			if humanoid then
				humanoid.WalkSpeed = 48 -- ê¸°ë³¸ ì´ë™ì†ë„ 3ë°°
			end
			
			-- ë¦¬ìŠ¤í° ì‹œ ì„¬ ë°©ë¬¸ ìˆœì„œ ì´ˆê¸°í™” (ì ìƒ‰ ì„¬ì—ì„œ ì‹œì‘í•˜ë¯€ë¡œ Next MapëŠ” ë…¸ë€ìƒ‰)
			player:SetAttribute("NextTargetIsland", 3)

			local root = char:WaitForChild("HumanoidRootPart", 10)
			if not root then return end
			
			local connection
			connection = RunService.Heartbeat:Connect(function()
				if not char.Parent or not root.Parent then connection:Disconnect() return end
				
				if root.Position.Y < -5 and not root:FindFirstChild("ScreamSound") then
					local sound = Instance.new("Sound")
					sound.Name = "ScreamSound"
					sound.SoundId = "rbxassetid://9113601347" -- ë¹„ëª… ì†Œë¦¬
					sound.Volume = 1.5
					sound.Parent = root
					sound:Play()
				end
			end)
		end)
	end

	Players.PlayerAdded:Connect(onPlayerAdded)
	for _, player in ipairs(Players:GetPlayers()) do
		onPlayerAdded(player)
	end
	
	-- ì•„ì´í…œ ì‚¬ìš© ìš”ì²­ ì²˜ë¦¬
	ReplicatedStorage:WaitForChild("UseItem").OnServerEvent:Connect(function(player)
		MapService.UseItem(player)
	end)

	-- ì•„ì´í…œ ìƒì„± ë£¨í”„ (10~20ì´ˆ ê°„ê²©)
	task.spawn(function()
		while true do
			task.wait(math.random(5, 10))
			MapService.SpawnRandomItem()
		end
	end)
end

function MapService.GenerateMap()
	-- ê¸°ì¡´(ê¸°ë³¸) ìŠ¤í° í¬ì¸íŠ¸ ì œê±°
	for _, child in ipairs(workspace:GetChildren()) do
		if child:IsA("SpawnLocation") then
			child:Destroy()
		end
	end

	local center = Vector3.new(0, 10, 0)
	local radiusFromCenter = 120
	local islandRadius = 40
	local islandHeight = 5
	
	local islandColors = {
		Color3.fromRGB(255, 0, 0),   -- ì ìƒ‰
		Color3.fromRGB(0, 0, 255),   -- íŒŒë€ìƒ‰
		Color3.fromRGB(255, 255, 0)  -- ë…¸ë€ìƒ‰
	}
	
	-- 1. ì„¬ 3ê°œ ìƒì„± (ì •ì‚¼ê°í˜• ë°°ì¹˜)
	for i = 1, 3 do
		local angle = math.rad((i - 1) * 120)
		local offsetX = math.cos(angle) * radiusFromCenter
		local offsetZ = math.sin(angle) * radiusFromCenter
		local position = center + Vector3.new(offsetX, 0, offsetZ)
		
		table.insert(islandPositions, position)
		
		local island = Instance.new("Part")
		island.Name = "Island_" .. i
		island.Shape = Enum.PartType.Cylinder
		island.Anchored = true
		island.Material = Enum.Material.Grass
		island.Color = islandColors[i]
		-- CylinderëŠ” Xì¶•ì´ ë†’ì´(ë‘ê»˜)ì…ë‹ˆë‹¤.
		island.Size = Vector3.new(islandHeight, islandRadius * 2, islandRadius * 2)
		-- ëˆ•í˜€ì„œ í‰í‰í•˜ê²Œ ë§Œë“¤ê¸° ìœ„í•´ Zì¶•ìœ¼ë¡œ 90ë„ íšŒì „
		island.CFrame = CFrame.new(position) * CFrame.Angles(0, 0, math.rad(90))
		island.Parent = workspace

		-- ì„¬ ë°©ë¬¸ ë¡œì§ (ì ìƒ‰ -> ë…¸ë€ìƒ‰ -> íŒŒë€ìƒ‰ ìˆœì„œ)
		island.Touched:Connect(function(hit)
			local player = Players:GetPlayerFromCharacter(hit.Parent)
			if not player or not player.Character or player.Character.Humanoid.Health <= 0 then return end
			
			local nextTarget = player:GetAttribute("NextTargetIsland") or 3
			
			if i == nextTarget then
				if i == 3 then -- ë…¸ë€ìƒ‰(3) -> ë‹¤ìŒ íŒŒë€ìƒ‰(2)
					player:SetAttribute("NextTargetIsland", 2)
					print(player.Name .. ": ë…¸ë€ìƒ‰ ì„¬ í†µê³¼! ë‹¤ìŒì€ íŒŒë€ìƒ‰ ì„¬ì…ë‹ˆë‹¤.")
				elseif i == 2 then -- íŒŒë€ìƒ‰(2) -> ë‹¤ìŒ ì ìƒ‰(1)
					player:SetAttribute("NextTargetIsland", 1)
					print(player.Name .. ": íŒŒë€ìƒ‰ ì„¬ í†µê³¼! ë‹¤ìŒì€ ì ìƒ‰ ì„¬ì…ë‹ˆë‹¤.")
				elseif i == 1 then -- ì ìƒ‰(1) -> ì™„ì£¼ -> ë‹¤ì‹œ ë…¸ë€ìƒ‰(3)
					player:SetAttribute("NextTargetIsland", 3)
					local leaderstats = player:FindFirstChild("leaderstats")
					local score = leaderstats and leaderstats:FindFirstChild("Score (1000 Win)")
					if score then 
						score.Value += 100
						
						-- ìŠ¹ë¦¬ ì¡°ê±´ ì²´í¬ (1000ì  ë‹¬ì„±)
						if score.Value >= 1000 then
							print("ğŸ† " .. player.Name .. " ë‹˜ì´ 1000ì ì„ ë‹¬ì„±í•˜ì—¬ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! (ê²Œì„ ì´ˆê¸°í™”)")
							-- ëª¨ë“  í”Œë ˆì´ì–´ ì ìˆ˜ ì´ˆê¸°í™”
							for _, p in ipairs(Players:GetPlayers()) do
								local ls = p:FindFirstChild("leaderstats")
								local s = ls and ls:FindFirstChild("Score (1000 Win)")
								if s then s.Value = 0 end
							end
						end
					end
					print(player.Name .. ": ì½”ìŠ¤ ì™„ì£¼! 100ì  íšë“.")
				end
			end
		end)

		-- ìŠ¤í° í¬ì¸íŠ¸ ì¶”ê°€
		if i == 1 then -- ì ìƒ‰ ì„¬(ì²« ë²ˆì§¸)ì—ë§Œ ìŠ¤í° ìƒì„±
			local spawn = Instance.new("SpawnLocation")
			spawn.Name = "SpawnLocation_" .. i
			spawn.Anchored = true
			spawn.Size = Vector3.new(16, 1, 16)
			spawn.Position = position + Vector3.new(0, islandHeight / 2 + 5, 0) -- ìŠ¤í° ìœ„ì¹˜ ìœ„ë¡œ ì´ë™
			spawn.Neutral = true
			spawn.Transparency = 1
			spawn.CanCollide = false
			spawn.Parent = workspace
		end
	end
	
	-- 2. ë‹¤ë¦¬ ì—°ê²° (1-2, 2-3, 3-1) - ê³¡ì„  ë‹¤ë¦¬ ì ìš©
	local bridgeSegments = 20 -- ê³¡ì„ ì„ êµ¬ì„±í•  íŒŒíŠ¸ ê°œìˆ˜ (ì¡°ì • ê°€ëŠ¥: ë†’ì„ìˆ˜ë¡ ë¶€ë“œëŸ¬ì›€)
	local curvature = 60 -- ê³¡ë¥  (ì¡°ì • ê°€ëŠ¥: í´ìˆ˜ë¡ ë°”ê¹¥ìª½ìœ¼ë¡œ ë§ì´ íœ¨)

	local function getBezierPoint(t, p0, p1, p2)
		return (1 - t)^2 * p0 + 2 * (1 - t) * t * p1 + t^2 * p2
	end

	for i = 1, 3 do
		local p0 = islandPositions[i]
		local p2 = islandPositions[(i % 3) + 1]
		
		-- ì œì–´ì (Control Point) ê³„ì‚°: ë‘ ì„¬ì˜ ì¤‘ê°„ ì§€ì ì—ì„œ ì¤‘ì‹¬ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ curvatureë§Œí¼ ì´ë™
		local midPoint = (p0 + p2) / 2
		local dir = (midPoint - center).Unit
		local p1 = midPoint + (dir * curvature)
		
		for j = 1, bridgeSegments do
			local t1 = (j - 1) / bridgeSegments
			local t2 = j / bridgeSegments
			
			local startPos = getBezierPoint(t1, p0, p1, p2)
			local endPos = getBezierPoint(t2, p0, p1, p2)
			local segDist = (endPos - startPos).Magnitude
			local segCenter = (startPos + endPos) / 2
			
			local bridge = Instance.new("Part")
			bridge.Name = "BridgeSegment"
			bridge.Anchored = true
			bridge.Material = Enum.Material.Wood
			bridge.Color = Color3.fromRGB(139, 69, 19) -- ê°ˆìƒ‰
			bridge.Size = Vector3.new(20, 1, segDist + 0.5) -- í‹ˆìƒˆ ë°©ì§€ ì˜¤ë²„ë©
			bridge.CFrame = CFrame.lookAt(segCenter, endPos)
			bridge.Parent = workspace
			
			-- ë‹¤ë¦¬ ë‚œê°„ ìƒì„±
			if (segCenter - p0).Magnitude > islandRadius and (segCenter - p2).Magnitude > islandRadius then
				local wallHeight = 5
				local wallThickness = 1
				local bridgeWidth = 20
				for _, side in ipairs({-1, 1}) do
					local wall = Instance.new("Part")
					wall.Name = "BridgeWall"
					wall.Anchored = true
					wall.Material = Enum.Material.Wood
					wall.Color = Color3.fromRGB(139, 69, 19)
					wall.Size = Vector3.new(wallThickness, wallHeight, segDist + 0.5)
					wall.CFrame = bridge.CFrame * CFrame.new(side * (bridgeWidth/2 - wallThickness/2), 0.5 + wallHeight/2, 0)
					wall.Parent = workspace
				end
			end
		end
	end
end

-- ì•„ì´í…œ ì¢…ë¥˜ ì •ì˜
local ITEM_TYPES = {"SpeedBoost", "StunGun", "Wall"}

function MapService.SpawnRandomItem()
	if #islandPositions == 0 then return end
	
	-- ì•„ì´í…œì´ ì—†ëŠ” ì„¬ ì°¾ê¸°
	local availableIslands = {}
	for _, pos in ipairs(islandPositions) do
		local isOccupied = false
		local checkPos = pos + Vector3.new(0, 3, 0)
		local parts = workspace:GetPartBoundsInRadius(checkPos, 5)
		for _, part in ipairs(parts) do
			if part.Name == "ItemBox" then
				isOccupied = true
				break
			end
		end
		if not isOccupied then
			table.insert(availableIslands, pos)
		end
	end

	if #availableIslands == 0 then return end

	local randomIslandPos = availableIslands[math.random(1, #availableIslands)]
	local itemType = ITEM_TYPES[math.random(1, #ITEM_TYPES)]
	
	local itemPart = Instance.new("Part")
	itemPart.Name = "ItemBox"
	itemPart.Size = Vector3.new(2, 2, 2)
	itemPart.Position = randomIslandPos + Vector3.new(0, 3, 0)
	itemPart.Color = Color3.fromRGB(255, 0, 255) -- ë³´ë¼ìƒ‰ ë°•ìŠ¤
	itemPart.Material = Enum.Material.Neon
	itemPart.Anchored = false
	itemPart.Parent = workspace
	
	-- ì•„ì´í…œ í…ìŠ¤íŠ¸ í‘œì‹œ
	local billboard = Instance.new("BillboardGui")
	billboard.Size = UDim2.new(0, 100, 0, 50)
	billboard.Adornee = itemPart
	billboard.AlwaysOnTop = true
	billboard.Parent = itemPart
	
	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(1, 0, 1, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.Text = itemType
	textLabel.TextColor3 = Color3.new(1, 1, 1)
	textLabel.TextStrokeTransparency = 0
	textLabel.Parent = billboard

	-- íšë“ ë¡œì§
	local collected = false
	itemPart.Touched:Connect(function(hit)
		if collected then return end
		local player = Players:GetPlayerFromCharacter(hit.Parent)
		if player then
			-- ì¸ë²¤í† ë¦¬ í™•ì¸ (Folder ì‚¬ìš©)
			local inventory = player:FindFirstChild("Inventory")
			if not inventory then
				inventory = Instance.new("Folder")
				inventory.Name = "Inventory"
				inventory.Parent = player
			end
			
			if #inventory:GetChildren() < 2 then
				collected = true
				local itemValue = Instance.new("StringValue")
				itemValue.Name = "Item"
				itemValue.Value = itemType
				itemValue.Parent = inventory
				
				itemPart:Destroy()
				print(player.Name .. " ë‹˜ì´ ì•„ì´í…œ íšë“: " .. itemType)
			end
		end
	end)
	
	Debris:AddItem(itemPart, 30) -- 30ì´ˆ í›„ ì‚­ì œ (ì²­ì†Œ)
end

function MapService.UseItem(player)
	local inventory = player:FindFirstChild("Inventory")
	if not inventory then return end
	
	local items = inventory:GetChildren()
	if #items > 0 then
		local itemToUse = items[1] -- ì²« ë²ˆì§¸ ì•„ì´í…œ ì‚¬ìš© (FIFO)
		local itemType = itemToUse.Value
		itemToUse:Destroy() -- ì¸ë²¤í† ë¦¬ì—ì„œ ì œê±°
		
		local char = player.Character
		if not char then return end
		local root = char:FindFirstChild("HumanoidRootPart")
		local humanoid = char:FindFirstChild("Humanoid")
		
		print(player.Name .. " ì•„ì´í…œ ì‚¬ìš©: " .. itemType)
		
		local sound = Instance.new("Sound")
		sound.SoundId = "rbxassetid://12221967" -- ì•„ì´í…œ ì‚¬ìš© íš¨ê³¼ìŒ
		sound.Parent = root
		sound:Play()
		Debris:AddItem(sound, 1)

		if itemType == "SpeedBoost" then
			-- 1. ì´ë™ì†ë„ ì¦ê°€ (3ì´ˆê°„ 3ë°°)
			local originalSpeed = humanoid.WalkSpeed
			humanoid.WalkSpeed = originalSpeed * 3
			task.delay(3, function()
				if humanoid then humanoid.WalkSpeed = originalSpeed end
			end)
			
		elseif itemType == "StunGun" then
			-- 3. ìŠ¤í„´ì´ (íˆ¬ì‚¬ì²´ ë°œì‚¬)
			if root then
				local bullet = Instance.new("Part")
				bullet.Size = Vector3.new(1, 1, 2)
				bullet.Color = Color3.fromRGB(255, 255, 0)
				bullet.Material = Enum.Material.Neon
				bullet.CFrame = root.CFrame * CFrame.new(0, 0, -3)
				bullet.Velocity = root.CFrame.LookVector * 100
				bullet.CanCollide = false
				bullet.Parent = workspace
				
				bullet.Touched:Connect(function(hit)
					if hit.Parent == char then return end -- ìê¸° ìì‹  ë¬´ì‹œ
					local targetHum = hit.Parent:FindFirstChild("Humanoid")
					if targetHum then
						local targetRoot = hit.Parent:FindFirstChild("HumanoidRootPart")
						if targetRoot then
							targetRoot.Anchored = true
							task.delay(3, function()
								if targetRoot then targetRoot.Anchored = false end
							end)
							bullet:Destroy()
						end
					end
				end)
				Debris:AddItem(bullet, 3) -- 3ì´ˆ í›„(ë§µ ë²—ì–´ë‚˜ë©´) ì‚­ì œ
			end
			
		elseif itemType == "Wall" then
			-- 4. ë²½ ìƒì„±
			if root then
				local wall = Instance.new("Part")
				wall.Size = Vector3.new(30, 30, 2)
				wall.CFrame = root.CFrame * CFrame.new(0, 0, 10)
				wall.Anchored = true
				wall.BrickColor = BrickColor.new("Dark stone grey")
				wall.Parent = workspace
				
				-- 8ì´ˆ í›„ ì„œì„œíˆ íˆ¬ëª…í•´ì§€ë©° ì‚¬ë¼ì§ (ì´ 10ì´ˆ ì§€ì†)
				task.delay(8, function()
					if wall and wall.Parent then
						local tween = TweenService:Create(wall, TweenInfo.new(2), {Transparency = 1})
						tween:Play()
						tween.Completed:Connect(function()
							wall:Destroy()
						end)
					end
				end)
			end
		end
	end
end

return MapService